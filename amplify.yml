version: 1
env:
  variables:
    # Build-time environment variables
    NODE_ENV: production
    VITE_ENFORCE_HTTPS: "true"
    VITE_ENABLE_HSTS: "true"
    VITE_ENABLE_CSP: "true"
  # Branch-specific environment variables
  main:
    variables:
      VITE_CLERK_PUBLISHABLE_KEY: pk_test_d29ya2FibGUtbWFydGluLTAuY2xlcmsuYWNjb3VudHMuZGV2JA
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_d29ya2FibGUtbWFydGluLTAuY2xlcmsuYWNjb3VudHMuZGV2JA
      CLERK_SECRET_KEY: sk_test_SThTzDsbXHbUr9wjn1srdFmnMXTrkeAxCu5gOif5uW
      VITE_API_BASE_URL: https://stock-ticker-api-staging.onrender.com
      VITE_DEBUG_MODE: "true"
      VITE_LOG_LEVEL: "debug"
      VITE_INSTANCE_ID: "staging"
      VITE_SESSION_DOMAIN: "main"
  staging:
    variables:
      VITE_CLERK_PUBLISHABLE_KEY: pk_test_d29ya2FibGUtbWFydGluLTAuY2xlcmsuYWNjb3VudHMuZGV2JA
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: pk_test_d29ya2FibGUtbWFydGluLTAuY2xlcmsuYWNjb3VudHMuZGV2JA
      CLERK_SECRET_KEY: sk_test_SThTzDsbXHbUr9wjn1srdFmnMXTrkeAxCu5gOif5uW
      VITE_API_BASE_URL: https://stock-ticker-api-staging.onrender.com
      VITE_DEBUG_MODE: "true"
      VITE_LOG_LEVEL: "debug"
      VITE_INSTANCE_ID: "staging"
      VITE_SESSION_DOMAIN: "staging"
  develop:
    variables:
      VITE_CLERK_PUBLISHABLE_KEY: $VITE_CLERK_PUBLISHABLE_KEY_DEV
      VITE_API_BASE_URL: $VITE_API_BASE_URL_DEV
      VITE_DEBUG_MODE: "true"
      VITE_LOG_LEVEL: "debug"
      VITE_INSTANCE_ID: "development"
      VITE_SESSION_DOMAIN: "dev"
      
frontend:
  phases:
    preBuild:
      commands:
        - echo "Node.js before upgrade:" && node -v && npm -v
        - nvm install 20 || echo "NVM install failed, trying alternative"
        - nvm use 20 || echo "NVM use failed, continuing with current version"
        - echo "Node.js after upgrade:" && node -v && npm -v
        - npm install -g npm@latest || echo "npm upgrade failed"
        - npm ci --include=dev
    build:
      commands:
        - echo "Building for production..."
        - npm run build:production
  artifacts:
    baseDirectory: dist
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
# SPA redirect rules for client-side routing
redirects:
  - source: '/remote'
    target: '/index.html'
    status: 200
  - source: '/remote/*'
    target: '/index.html'
    status: 200
  - source: '/<*>'
    target: '/index.html'
    status: 200
